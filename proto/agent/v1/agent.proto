syntax = "proto3";

package agent.v1;

option go_package = "github.com/forge/platform/gen/agent/v1;agentv1";

// AgentService is exposed by each agent container.
// The platform connects to agents as a client.
// The platform acts as a "dumb pipe" - it routes messages without parsing content.
service AgentService {
  // Connect establishes a bidirectional stream for real-time communication.
  // Platform sends requests, agent sends responses back.
  rpc Connect(stream AgentRequest) returns (stream AgentResponse);

  // GetStatus returns the current agent status (unary RPC for simple queries).
  rpc GetStatus(GetStatusRequest) returns (GetStatusResponse);

  // Shutdown gracefully terminates the agent.
  rpc Shutdown(ShutdownRequest) returns (ShutdownResponse);
}

// Request from platform to agent
message AgentRequest {
  string request_id = 1;

  oneof command {
    SendMessageRequest send_message = 2;
    InterruptRequest interrupt = 3;
    SetPermissionModeRequest set_permission_mode = 4;
    SetModelRequest set_model = 5;
  }
}

// Simple message request - just pass the user's prompt
message SendMessageRequest {
  string content = 1;
}

message InterruptRequest {}

message SetPermissionModeRequest {
  string mode = 1; // OpenCode permission mode
}

message SetModelRequest {
  string model = 1; // e.g., "anthropic/claude-sonnet-4"
}

// Response from agent to platform
message AgentResponse {
  string request_id = 1;
  string session_id = 2;
  uint64 seq = 3;
  int64 timestamp = 4;

  oneof payload {
    EventPayload event = 5;       // OpenCode event (JSON passthrough)
    ErrorPayload error = 6;       // Error occurred
    CompletePayload complete = 7; // Stream complete
  }
}

// Pass-through OpenCode event as JSON
// The platform does not parse this - it forwards directly to webhook consumers
message EventPayload {
  string event_type = 1;  // e.g., "message.updated", "session.status", "file.edited"
  bytes event_json = 2;   // Raw OpenCode event JSON
}

message ErrorPayload {
  string code = 1;
  string message = 2;
  bool fatal = 3; // If true, agent will terminate
}

message CompletePayload {
  bool success = 1;
}

// GetStatus - unchanged
message GetStatusRequest {}

message GetStatusResponse {
  string agent_id = 1;
  string session_id = 2;
  AgentState state = 3;
  int64 latest_seq = 4;
  string current_model = 5;
  string permission_mode = 6;
  int64 uptime_ms = 7;
}

enum AgentState {
  AGENT_STATE_UNSPECIFIED = 0;
  AGENT_STATE_IDLE = 1;
  AGENT_STATE_PROCESSING = 2;
  AGENT_STATE_ERROR = 3;
}

// Shutdown - unchanged
message ShutdownRequest {
  bool graceful = 1;
}

message ShutdownResponse {
  bool success = 1;
}
